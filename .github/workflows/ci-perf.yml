name: CI - Perf

on:
  push:
    paths:
      - 'src/**'
      - 'tests/**'
      - '.github/**'
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - '.github/**'
  workflow_dispatch:
    inputs:
      baseline:
        description: 'Baseline mode. latest: compare against latest benchmarks; rebaseline: store new baseline.'
        type: choice
        default: 'latest'
        options:
          - 'latest'
          - 'rebaseline'

jobs:
  tests:
    name: Benchmarks
    runs-on: ubuntu-latest

    continue-on-error: true # This job is experimental
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: true
      - uses: ./.github/actions/setup-action
        with:
          extensions: xdebug

      - name: Fetch Benchmarks
        run: |
          git fetch origin benchmarks
          mkdir -p .phpbench
          git checkout origin/benchmarks -- .phpbench || echo "No previous benchmarks found"
      
      - name: Run Benchmarks
        run: |
          # Baseline does not exist or rebaseline requested. Generate it.
          if [ -z "$(ls -A .phpbench)" ] || [ "${{ github.event.inputs.baseline || 'latest' }}" = "rebaseline" ]; then
            vendor/bin/phpbench run --report=aggregate --progress=plain --store --tag=${GITHUB_SHA}

          # On main branch push, update baseline with tolerance for failures.
          elif [ "${GITHUB_REF}" = "refs/heads/main" ] && [ "${GITHUB_EVENT_NAME}" = "push" ]; then
            vendor/bin/phpbench run --report=aggregate --progress=plain --store --tag=${GITHUB_SHA} --ref=latest --tolerate-failure

          # On other branches, compare against latest baseline, fails if worse.
          else 
            vendor/bin/phpbench run --report=aggregate --progress=plain --store --tag=${GITHUB_SHA} --ref=latest
          fi
          
          # Generate report for human consumption
          vendor/bin/phpbench report --report=aggregate --ref=latest |
            tail -n+2 | head -n-2 | tr '+' '|' > report.md

          cat report.md

      - name: Commit Results
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout benchmarks
          mv -f report.md latest.md
          git add .phpbench latest.md
          git commit -m "Store benchmark results [skip ci]" || echo "No changes to commit"
          git push origin benchmarks

      - name: Restore workspace
        if: always()
        run: |
          set -euo pipefail
          echo "Restoring workspace to original commit: ${GITHUB_SHA}"
          git fetch origin || true
          git checkout --detach "${GITHUB_SHA}"
          git reset --hard "${GITHUB_SHA}"